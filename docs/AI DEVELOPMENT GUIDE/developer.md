 å…³äºé›†æˆå¤§æ¨¡å‹ä¸“å®¶ç³»ç»Ÿçš„æ¶æ„åˆ†ææŠ¥å‘Š

  ä¸€ã€é¡¹ç›®ç°çŠ¶æ€»ç»“

  ComtradeReader æ˜¯ä¸€ä¸ªæˆç†Ÿçš„ç”µåŠ›ç³»ç»Ÿæš‚æ€æ³¢å½¢åˆ†æå·¥å…·ï¼ˆv2.0.4ï¼‰ï¼Œç”¨äºè¯»å–ã€åˆ†æå’Œå¯è§†åŒ– COMTRADE æ ‡å‡†æ ¼å¼çš„ç”µåŠ›æ•…éšœå½•æ³¢æ•°æ®ã€‚ä»£ç åº“çº¦
  2859 è¡Œï¼Œæ¶æ„æ¸…æ™°ï¼Œæ¨¡å—åŒ–è®¾è®¡è‰¯å¥½ã€‚

  æ ¸å¿ƒèƒ½åŠ›ï¼š
  - è§£æ COMTRADE æ–‡ä»¶ï¼ˆ.cfg/.dat/.hdr/.rptï¼‰
  - æå–æ¨¡æ‹Ÿé‡å’Œæ•°å­—é‡é€šé“æ•°æ®
  - äº¤äº’å¼ HTML æ³¢å½¢å¯è§†åŒ–
  - æ’ä»¶ç³»ç»Ÿæ”¯æŒåŠŸèƒ½æ‰©å±•
  - äº‹ä»¶æ—¶é—´çº¿åˆ†æï¼ˆHDR æ–‡ä»¶ï¼‰
  - ç»Ÿè®¡åˆ†æå’Œæ•°æ®å¯¼å‡º

  ---
  äºŒã€ç°æœ‰æ¶æ„ä¼˜åŠ¿

  ä½ çš„é¡¹ç›®å·²ç»å…·å¤‡äº†æä½³çš„ AI é›†æˆåŸºç¡€ï¼š

  1. âœ… æ’ä»¶æ¶æ„ï¼šwaveform_viewer/plugins/ æä¾›äº†æ ‡å‡†åŒ–çš„æ‰©å±•æœºåˆ¶
  2. âœ… ç­–ç•¥æ¨¡å¼ï¼šé€šé“é€‰æ‹©å’Œå¯è§†åŒ–éƒ½æ”¯æŒè‡ªå®šä¹‰ç­–ç•¥
  3. âœ… æ¸…æ™°çš„æ•°æ®æ¨¡å‹ï¼šComtradeReader ç±»å°è£…äº†æ‰€æœ‰æ³¢å½¢æ•°æ®
  4. âœ… ç¼–ç¨‹å¼ APIï¼šä¸ä»…æœ‰ CLIï¼Œè¿˜å¯ä»¥ä½œä¸º Python åº“è°ƒç”¨
  5. âœ… å·¥å…·å‡½æ•°åŸºç¡€ï¼šå·²æœ‰ç»Ÿè®¡åˆ†æã€CSV/JSON å¯¼å‡ºç­‰å·¥å…·æ’ä»¶

  ---
  ä¸‰ã€å»ºè®®çš„é›†æˆæ¶æ„

  æˆ‘å»ºè®®é‡‡ç”¨ä¸‰å±‚æ¶æ„æ¥é›†æˆå¤§æ¨¡å‹ä¸“å®¶ç³»ç»Ÿï¼š

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚              Layer 3: AI Expert Interface               â”‚
  â”‚  (è‡ªç„¶è¯­è¨€æŸ¥è¯¢ â†’ æ„å›¾è¯†åˆ« â†’ å·¥å…·è°ƒç”¨ â†’ ç»“æœè§£é‡Š)          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚           Layer 2: Analysis Tool Registry               â”‚
  â”‚   (æ ‡å‡†åŒ–çš„å·¥å…·å‡½æ•°ï¼Œä¾› LLM Function Calling ä½¿ç”¨)         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚         Layer 1: Existing Core Components               â”‚
  â”‚    (ComtradeReader, Plugins, Visualizers - ä¿æŒä¸å˜)     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  å››ã€å…·ä½“å®æ–½æ–¹æ¡ˆ

  é˜¶æ®µ 1ï¼šæ„å»ºå·¥å…·æ³¨å†Œè¡¨ï¼ˆTool Registryï¼‰

  åœ¨ waveform_viewer/ai/ ä¸‹åˆ›å»ºæ–°æ¨¡å—ï¼š

  waveform_viewer/ai/
  â”œâ”€â”€ __init__.py
  â”œâ”€â”€ tools/                      # AI å¯è°ƒç”¨çš„å·¥å…·å‡½æ•°
  â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”œâ”€â”€ data_access.py         # æ•°æ®è¯»å–å·¥å…·
  â”‚   â”œâ”€â”€ basic_analysis.py      # åŸºç¡€åˆ†æï¼ˆç»Ÿè®¡ã€å³°å€¼æ£€æµ‹ï¼‰
  â”‚   â”œâ”€â”€ advanced_analysis.py   # é«˜çº§åˆ†æï¼ˆFFTã€THDã€è°æ³¢ï¼‰
  â”‚   â”œâ”€â”€ event_analysis.py      # äº‹ä»¶åˆ†æï¼ˆæ•…éšœæ—¶åºã€ä¿æŠ¤åŠ¨ä½œï¼‰
  â”‚   â”œâ”€â”€ comparison.py          # å¤šæ–‡ä»¶å¯¹æ¯”
  â”‚   â””â”€â”€ reporting.py           # æŠ¥å‘Šç”Ÿæˆ
  â”œâ”€â”€ tool_registry.py           # å·¥å…·æ³¨å†Œå’Œå…ƒæ•°æ®ç®¡ç†
  â””â”€â”€ function_schemas.py        # LLM Function Calling çš„ JSON Schema

  å·¥å…·å‡½æ•°ç¤ºä¾‹ï¼š

  # waveform_viewer/ai/tools/data_access.py
  def list_available_channels(cfg_path: str) -> Dict[str, Any]:
      """åˆ—å‡ºæ‰€æœ‰å¯ç”¨é€šé“åŠå…¶å…ƒæ•°æ®"""
      reader = ComtradeReader(cfg_path)
      return {
          "station": reader.station_name,
          "analog_channels": [
              {"index": ch.index, "name": ch.name, "unit": ch.unit}
              for ch in reader.analog_channels
          ],
          "digital_channels": reader.digital_channels,
          "sample_rate": reader.sample_rate,
          "duration": reader.time_values[-1]
      }

  def get_channel_data(cfg_path: str, channel_name: str) -> Dict:
      """è·å–æŒ‡å®šé€šé“çš„æ—¶åºæ•°æ®"""
      reader = ComtradeReader(cfg_path)
      channel = reader.get_channel_by_name(channel_name)
      if not channel:
          raise ValueError(f"Channel {channel_name} not found")

      data = reader.get_analog_data(channel.index)
      return {
          "name": channel.name,
          "unit": channel.unit,
          "time": reader.time_values,
          "values": data
      }

  # waveform_viewer/ai/tools/basic_analysis.py
  def calculate_statistics(cfg_path: str, channel_name: str) -> Dict:
      """è®¡ç®—é€šé“ç»Ÿè®¡ç‰¹å¾"""
      reader = ComtradeReader(cfg_path)
      channel = reader.get_channel_by_name(channel_name)
      data = np.array(reader.get_analog_data(channel.index))

      return {
          "min": float(np.min(data)),
          "max": float(np.max(data)),
          "mean": float(np.mean(data)),
          "std": float(np.std(data)),
          "rms": float(np.sqrt(np.mean(data**2))),
          "peak_to_peak": float(np.ptp(data))
      }

  def detect_voltage_sags(cfg_path: str, threshold_percent: float = 90) -> List[Dict]:
      """æ£€æµ‹ç”µå‹è·Œè½äº‹ä»¶"""
      reader = ComtradeReader(cfg_path)
      # æŸ¥æ‰¾ç”µå‹é€šé“
      voltage_channels = [ch for ch in reader.analog_channels if 'ç”µå‹' in ch.name]

      events = []
      for ch in voltage_channels:
          data = np.array(reader.get_analog_data(ch.index))
          threshold = threshold_percent  # å‡è®¾å•ä½æ˜¯ç™¾åˆ†æ¯”
          sag_indices = np.where(data < threshold)[0]

          if len(sag_indices) > 0:
              events.append({
                  "channel": ch.name,
                  "start_time": reader.time_values[sag_indices[0]],
                  "duration": (sag_indices[-1] - sag_indices[0]) / reader.sample_rate,
                  "min_value": float(np.min(data[sag_indices]))
              })

      return events

  # waveform_viewer/ai/tools/advanced_analysis.py
  from scipy import signal
  from scipy.fft import fft, fftfreq

  def perform_fft_analysis(cfg_path: str, channel_name: str) -> Dict:
      """é¢‘åŸŸåˆ†æï¼ˆFFTï¼‰"""
      reader = ComtradeReader(cfg_path)
      channel = reader.get_channel_by_name(channel_name)
      data = np.array(reader.get_analog_data(channel.index))

      # FFT è®¡ç®—
      N = len(data)
      yf = fft(data)
      xf = fftfreq(N, 1/reader.sample_rate)[:N//2]

      # åªè¿”å›æ­£é¢‘ç‡éƒ¨åˆ†
      magnitude = 2.0/N * np.abs(yf[:N//2])

      # æ‰¾åˆ°ä¸»è¦é¢‘ç‡åˆ†é‡ï¼ˆå‰ 5 ä¸ªå³°å€¼ï¼‰
      peaks, _ = signal.find_peaks(magnitude, height=np.max(magnitude)*0.1)
      top_freqs = sorted(zip(xf[peaks], magnitude[peaks]),
                        key=lambda x: x[1], reverse=True)[:5]

      return {
          "fundamental_freq": reader.frequency,
          "sample_rate": reader.sample_rate,
          "frequencies": xf.tolist()[:100],  # é™åˆ¶è¿”å›æ•°æ®é‡
          "magnitudes": magnitude.tolist()[:100],
          "dominant_frequencies": [
              {"frequency": f, "magnitude": m} for f, m in top_freqs
          ]
      }

  def calculate_thd(cfg_path: str, channel_name: str) -> float:
      """è®¡ç®—æ€»è°æ³¢ç•¸å˜ç‡ï¼ˆTHDï¼‰"""
      fft_result = perform_fft_analysis(cfg_path, channel_name)
      freqs = fft_result["dominant_frequencies"]

      if len(freqs) < 2:
          return 0.0

      fundamental = freqs[0]["magnitude"]
      harmonics = sum(f["magnitude"]**2 for f in freqs[1:])

      return 100 * np.sqrt(harmonics) / fundamental if fundamental > 0 else 0

  # waveform_viewer/ai/tools/event_analysis.py
  def extract_fault_timeline(cfg_path: str) -> Dict:
      """æå–æ•…éšœäº‹ä»¶æ—¶é—´çº¿ï¼ˆä» HDR æ–‡ä»¶ï¼‰"""
      hdr_path = cfg_path.replace('.cfg', '.hdr')
      if not os.path.exists(hdr_path):
          return {"error": "HDR file not found"}

      hdr_reader = HdrReader(hdr_path)

      return {
          "fault_start_time": hdr_reader.fault_start_time,
          "trip_info": [
              {
                  "time": trip.time,
                  "trip_signal": trip.trip_signal,
                  "relay": trip.relay_name
              }
              for trip in hdr_reader.trip_infos
          ],
          "digital_events": [
              {
                  "time": event.time,
                  "name": event.name,
                  "status": event.status
              }
              for event in hdr_reader.digital_events
          ]
      }

  ---
  é˜¶æ®µ 2ï¼šåˆ›å»ºå·¥å…·æ³¨å†Œè¡¨å’Œ Function Schema

  # waveform_viewer/ai/tool_registry.py
  from typing import Dict, List, Callable
  import inspect

  class ToolRegistry:
      """AI å·¥å…·æ³¨å†Œä¸­å¿ƒ"""

      def __init__(self):
          self._tools: Dict[str, Callable] = {}
          self._schemas: Dict[str, Dict] = {}

      def register(self, func: Callable, schema: Dict):
          """æ³¨å†Œå·¥å…·å‡½æ•°åŠå…¶ schema"""
          self._tools[func.__name__] = func
          self._schemas[func.__name__] = schema

      def get_tool(self, name: str) -> Callable:
          """è·å–å·¥å…·å‡½æ•°"""
          return self._tools.get(name)

      def get_all_schemas(self) -> List[Dict]:
          """è·å–æ‰€æœ‰å·¥å…·çš„ Function Calling schemas"""
          return list(self._schemas.values())

      def execute(self, tool_name: str, **kwargs) -> Any:
          """æ‰§è¡Œå·¥å…·å‡½æ•°"""
          tool = self.get_tool(tool_name)
          if not tool:
              raise ValueError(f"Tool {tool_name} not found")
          return tool(**kwargs)

  # å…¨å±€æ³¨å†Œè¡¨å®ä¾‹
  registry = ToolRegistry()

  # waveform_viewer/ai/function_schemas.py
  """LLM Function Calling çš„ JSON Schema å®šä¹‰"""

  TOOL_SCHEMAS = [
      {
          "name": "list_available_channels",
          "description": "åˆ—å‡º COMTRADE æ–‡ä»¶ä¸­æ‰€æœ‰å¯ç”¨çš„é€šé“ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¨¡æ‹Ÿé‡å’Œæ•°å­—é‡é€šé“",
          "parameters": {
              "type": "object",
              "properties": {
                  "cfg_path": {
                      "type": "string",
                      "description": "COMTRADE é…ç½®æ–‡ä»¶ï¼ˆ.cfgï¼‰çš„è·¯å¾„"
                  }
              },
              "required": ["cfg_path"]
          }
      },
      {
          "name": "calculate_statistics",
          "description": "è®¡ç®—æŒ‡å®šé€šé“çš„ç»Ÿè®¡ç‰¹å¾ï¼ŒåŒ…æ‹¬æœ€å°å€¼ã€æœ€å¤§å€¼ã€å‡å€¼ã€æ ‡å‡†å·®ã€RMS ç­‰",
          "parameters": {
              "type": "object",
              "properties": {
                  "cfg_path": {"type": "string", "description": "CFG æ–‡ä»¶è·¯å¾„"},
                  "channel_name": {"type": "string", "description": "é€šé“åç§°æˆ–åŒ¹é…æ¨¡å¼"}
              },
              "required": ["cfg_path", "channel_name"]
          }
      },
      {
          "name": "detect_voltage_sags",
          "description": "æ£€æµ‹ç”µå‹è·Œè½äº‹ä»¶ï¼Œè¿”å›è·Œè½æ—¶åˆ»ã€æŒç»­æ—¶é—´å’Œæœ€å°å€¼",
          "parameters": {
              "type": "object",
              "properties": {
                  "cfg_path": {"type": "string"},
                  "threshold_percent": {
                      "type": "number",
                      "description": "ç”µå‹è·Œè½é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰ï¼Œé»˜è®¤ 90%"
                  }
              },
              "required": ["cfg_path"]
          }
      },
      {
          "name": "perform_fft_analysis",
          "description": "å¯¹æŒ‡å®šé€šé“è¿›è¡Œå¿«é€Ÿå‚…é‡Œå¶å˜æ¢ï¼ˆFFTï¼‰ï¼Œåˆ†æé¢‘åŸŸç‰¹å¾",
          "parameters": {
              "type": "object",
              "properties": {
                  "cfg_path": {"type": "string"},
                  "channel_name": {"type": "string"}
              },
              "required": ["cfg_path", "channel_name"]
          }
      },
      {
          "name": "extract_fault_timeline",
          "description": "ä» HDR æ–‡ä»¶ä¸­æå–æ•…éšœäº‹ä»¶æ—¶é—´çº¿ï¼ŒåŒ…æ‹¬æ•…éšœæ—¶åˆ»ã€ä¿æŠ¤åŠ¨ä½œã€è·³é—¸ä¿¡æ¯",
          "parameters": {
              "type": "object",
              "properties": {
                  "cfg_path": {"type": "string"}
              },
              "required": ["cfg_path"]
          }
      }
      # ... æ›´å¤šå·¥å…·
  ]

  ---
  é˜¶æ®µ 3ï¼šæ„å»º AI ä¸“å®¶æ¥å£

  # waveform_viewer/ai/expert.py
  from typing import List, Dict, Any
  import json

  class WaveformExpert:
      """ç”µåŠ›æ³¢å½¢åˆ†æä¸“å®¶ç³»ç»Ÿï¼ˆLLM é©±åŠ¨ï¼‰"""

      def __init__(self, llm_client, tool_registry):
          """
          Args:
              llm_client: LLM å®¢æˆ·ç«¯ï¼ˆOpenAI/Claude/å…¶ä»–æ”¯æŒ Function Calling çš„ APIï¼‰
              tool_registry: ToolRegistry å®ä¾‹
          """
          self.llm = llm_client
          self.registry = tool_registry
          self.conversation_history = []

      def analyze(self, query: str, cfg_path: str) -> str:
          """
          è‡ªç„¶è¯­è¨€æŸ¥è¯¢æ¥å£
          
          Args:
              query: ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€é—®é¢˜ï¼Œä¾‹å¦‚ï¼š
                     "è¿™ä¸ªæ³¢å½¢æœ‰ç”µå‹è·Œè½å—ï¼Ÿ"
                     "Aç›¸ç”µæµçš„é¢‘è°±åˆ†ææ˜¾ç¤ºä»€ä¹ˆï¼Ÿ"
                     "æ•…éšœæ˜¯ä»€ä¹ˆæ—¶å€™å‘ç”Ÿçš„ï¼Ÿä¿æŠ¤æ˜¯å¦æ­£ç¡®åŠ¨ä½œï¼Ÿ"
              cfg_path: è¦åˆ†æçš„ COMTRADE æ–‡ä»¶è·¯å¾„
          
          Returns:
              ä¸“å®¶ç³»ç»Ÿçš„åˆ†æç»“æœï¼ˆè‡ªç„¶è¯­è¨€ï¼‰
          """
          # æ„å»ºç³»ç»Ÿæç¤ºè¯
          system_prompt = f"""ä½ æ˜¯ä¸€ä¸ªç”µåŠ›ç³»ç»Ÿæš‚æ€æ³¢å½¢åˆ†æä¸“å®¶ã€‚
  ä½ å¯ä»¥è°ƒç”¨å„ç§åˆ†æå·¥å…·æ¥å¸®åŠ©å›ç­”ç”¨æˆ·å…³äº COMTRADE æ³¢å½¢æ–‡ä»¶çš„é—®é¢˜ã€‚

  å½“å‰åˆ†æçš„æ–‡ä»¶ï¼š{cfg_path}

  ä½ å¯ä»¥ä½¿ç”¨çš„å·¥å…·åŒ…æ‹¬ï¼š
  - æ•°æ®è®¿é—®ï¼šæŸ¥çœ‹é€šé“åˆ—è¡¨ã€è¯»å–æ³¢å½¢æ•°æ®
  - åŸºç¡€åˆ†æï¼šç»Ÿè®¡ç‰¹å¾ã€å³°å€¼æ£€æµ‹ã€ç”µå‹è·Œè½æ£€æµ‹
  - é«˜çº§åˆ†æï¼šFFTé¢‘è°±åˆ†æã€è°æ³¢åˆ†æã€THD è®¡ç®—
  - äº‹ä»¶åˆ†æï¼šæ•…éšœæ—¶åºã€ä¿æŠ¤åŠ¨ä½œåˆ†æ
  - å¯¹æ¯”åˆ†æï¼šå¤šæ–‡ä»¶å¯¹æ¯”ã€åŸºçº¿åå·®

  è¯·æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ï¼Œé€‰æ‹©åˆé€‚çš„å·¥å…·è¿›è¡Œåˆ†æï¼Œå¹¶ç»™å‡ºä¸“ä¸šçš„è§£é‡Šã€‚"""

          # è°ƒç”¨ LLMï¼ˆæ”¯æŒ Function Callingï¼‰
          messages = [
              {"role": "system", "content": system_prompt},
              *self.conversation_history,
              {"role": "user", "content": query}
          ]

          response = self.llm.chat.completions.create(
              model="gpt-4",  # æˆ–å…¶ä»–æ¨¡å‹
              messages=messages,
              functions=self.registry.get_all_schemas(),
              function_call="auto"
          )

          # å¤„ç† Function Calling
          while response.choices[0].finish_reason == "function_call":
              func_call = response.choices[0].message.function_call
              func_name = func_call.name
              func_args = json.loads(func_call.arguments)

              # è‡ªåŠ¨æ³¨å…¥ cfg_pathï¼ˆå¦‚æœå·¥å…·éœ€è¦ï¼‰
              if "cfg_path" in func_args and not func_args["cfg_path"]:
                  func_args["cfg_path"] = cfg_path

              # æ‰§è¡Œå·¥å…·
              result = self.registry.execute(func_name, **func_args)

              # å°†ç»“æœè¿”å›ç»™ LLM
              messages.append({
                  "role": "function",
                  "name": func_name,
                  "content": json.dumps(result, ensure_ascii=False)
              })

              response = self.llm.chat.completions.create(
                  model="gpt-4",
                  messages=messages,
                  functions=self.registry.get_all_schemas(),
                  function_call="auto"
              )

          # è·å–æœ€ç»ˆå›ç­”
          answer = response.choices[0].message.content

          # æ›´æ–°å¯¹è¯å†å²
          self.conversation_history.append({"role": "user", "content": query})
          self.conversation_history.append({"role": "assistant", "content": answer})

          return answer

      def batch_analyze(self, tasks: List[Dict[str, str]]) -> List[str]:
          """æ‰¹é‡åˆ†æå¤šä¸ªä»»åŠ¡"""
          return [self.analyze(task["query"], task["cfg_path"]) for task in tasks]

      def reset_conversation(self):
          """é‡ç½®å¯¹è¯å†å²"""
          self.conversation_history = []

  ---
  é˜¶æ®µ 4ï¼šé›†æˆåˆ°ç°æœ‰åº”ç”¨

  # waveform_viewer/app.pyï¼ˆæ‰©å±•ç°æœ‰ç±»ï¼‰

  class WaveformViewerApp:
      # ... ç°æœ‰ä»£ç  ...

      def __init__(self, waves_dir, use_simple_menu=False, enable_ai=False):
          # ... ç°æœ‰åˆå§‹åŒ– ...

          # AI ä¸“å®¶ç³»ç»Ÿï¼ˆå¯é€‰ï¼‰
          self.ai_expert = None
          if enable_ai:
              from waveform_viewer.ai.expert import WaveformExpert
              from waveform_viewer.ai.tool_registry import registry
              # è¿™é‡Œéœ€è¦é…ç½® LLM å®¢æˆ·ç«¯
              self.ai_expert = WaveformExpert(llm_client, registry)

      def run_ai_query(self, cfg_path: str):
          """AI æŸ¥è¯¢æ¨¡å¼"""
          if not self.ai_expert:
              print("AI åŠŸèƒ½æœªå¯ç”¨")
              return

          print("\n=== AI ä¸“å®¶åˆ†ææ¨¡å¼ ===")
          print("è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ˆè¾“å…¥ 'exit' é€€å‡ºï¼‰ï¼š\n")

          while True:
              query = input("æ‚¨çš„é—®é¢˜ > ")
              if query.lower() == 'exit':
                  break

              print("\nğŸ¤– ä¸“å®¶æ­£åœ¨åˆ†æ...")
              answer = self.ai_expert.analyze(query, cfg_path)
              print(f"\nğŸ“Š åˆ†æç»“æœï¼š\n{answer}\n")

  # main.pyï¼ˆæ·»åŠ  AI æ¨¡å¼å…¥å£ï¼‰

  def main():
      parser = argparse.ArgumentParser(description='COMTRADE Waveform Viewer')
      parser.add_argument('--simple', action='store_true', help='ä½¿ç”¨ç®€åŒ–èœå•æ¨¡å¼')
      parser.add_argument('--ai', action='store_true', help='å¯ç”¨ AI ä¸“å®¶åˆ†æ')
      args = parser.parse_args()

      app = WaveformViewerApp("waves/",
                             use_simple_menu=args.simple,
                             enable_ai=args.ai)
      app.run()

  ---
  äº”ã€ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

  å¯ç”¨ AI æ¨¡å¼åçš„ç”¨æˆ·ä½“éªŒï¼š

  $ python main.py --ai

  === AI ä¸“å®¶åˆ†ææ¨¡å¼ ===
  æ‚¨çš„é—®é¢˜ > è¿™ä¸ªå½•æ³¢æ–‡ä»¶è®°å½•çš„æ˜¯ä»€ä¹ˆç±»å‹çš„æ•…éšœï¼Ÿ

  ğŸ¤– ä¸“å®¶æ­£åœ¨åˆ†æ...

  ğŸ“Š åˆ†æç»“æœï¼š
  æ ¹æ®å¯¹æ³¢å½¢æ•°æ®çš„åˆ†æï¼Œè¿™æ˜¯ä¸€æ¬¡**å•ç›¸æ¥åœ°æ•…éšœ**ã€‚ä¸»è¦ä¾æ®ï¼š

  1. **æ•…éšœæ—¶åˆ»**ï¼š11:52:40.123ï¼ˆä» HDR æ–‡ä»¶æå–ï¼‰
  2. **ç”µå‹ç‰¹å¾**ï¼šA ç›¸ç”µå‹è·Œè½è‡³ 15%ï¼ŒB/C ç›¸ç”µå‹ä¸Šå‡è‡³ 110%ï¼ˆå…¸å‹çš„å•ç›¸æ¥åœ°ç‰¹å¾ï¼‰
  3. **ç”µæµç‰¹å¾**ï¼šA ç›¸ç”µæµçªå¢è‡³ 8.5kAï¼Œé›¶åºç”µæµå‡ºç°æ˜æ˜¾å¢é‡
  4. **ä¿æŠ¤åŠ¨ä½œ**ï¼šè·ç¦»ä¿æŠ¤ I æ®µåœ¨æ•…éšœå 23ms åŠ¨ä½œï¼Œè·³é—¸æ­£ç¡®
  5. **é¢‘è°±åˆ†æ**ï¼šA ç›¸ç”µæµå‡ºç°æ˜æ˜¾çš„ 2 æ¬¡è°æ³¢åˆ†é‡ï¼ˆæ•…éšœç”µå¼§ç‰¹å¾ï¼‰

  å»ºè®®è¿›ä¸€æ­¥æ£€æŸ¥ï¼š
  - æ•…éšœç‚¹å®šä½ï¼ˆæ ¹æ®è¡Œæ³¢æˆ–é˜»æŠ—è®¡ç®—ï¼‰
  - æ¥åœ°ç”µé˜»å€¼ä¼°ç®—
  - ä¿æŠ¤é…ç½®æ˜¯å¦éœ€è¦ä¼˜åŒ–

  æ‚¨çš„é—®é¢˜ > A ç›¸ç”µæµçš„è°æ³¢å«é‡é«˜å—ï¼Ÿ

  ğŸ¤– ä¸“å®¶æ­£åœ¨åˆ†æ...

  ğŸ“Š åˆ†æç»“æœï¼š
  A ç›¸ç”µæµçš„è°æ³¢åˆ†æç»“æœï¼š

  - **æ€»è°æ³¢ç•¸å˜ç‡ï¼ˆTHDï¼‰**ï¼š12.3%ï¼ˆæ­£å¸¸è¿è¡Œæ—¶åº” <5%ï¼‰
  - **ä¸»è¦è°æ³¢åˆ†é‡**ï¼š
    - åŸºæ³¢ï¼ˆ50Hzï¼‰ï¼š8.5kA
    - 2 æ¬¡è°æ³¢ï¼ˆ100Hzï¼‰ï¼š0.85kAï¼ˆ10%ï¼‰
    - 5 æ¬¡è°æ³¢ï¼ˆ250Hzï¼‰ï¼š0.25kAï¼ˆ2.9%ï¼‰

  **ç»“è®º**ï¼šè°æ³¢å«é‡åé«˜ï¼Œä¸»è¦æ˜¯æ•…éšœç”µå¼§å¯¼è‡´çš„ 2 æ¬¡è°æ³¢ã€‚è¿™æ˜¯å…¸å‹çš„æ¥åœ°æ•…éšœç‰¹å¾ã€‚

  æ‚¨çš„é—®é¢˜ > exit

  ---
  å…­ã€æŠ€æœ¯é€‰å‹å»ºè®®

  LLM é€‰æ‹©ï¼š

  | é€‰é¡¹                | ä¼˜ç‚¹                         | ç¼ºç‚¹                          | æ¨èåœºæ™¯   |
  |-------------------|----------------------------|-----------------------------|--------|
  | OpenAI GPT-4      | Function Calling æˆç†Ÿã€API ç¨³å®š | éœ€è¦è”ç½‘ã€æœ‰æˆæœ¬                    | äº‘ç«¯éƒ¨ç½²   |
  | Claude 3.5 Sonnet | æ¨ç†èƒ½åŠ›å¼ºã€Token çª—å£å¤§            | Function Calling è¾ƒæ–°         | å¤æ‚åˆ†æä»»åŠ¡ |
  | æœ¬åœ°æ¨¡å‹ï¼ˆLlama 3.1ï¼‰   | æ— ç½‘ç»œè¦æ±‚ã€æˆæœ¬ä½                  | éœ€è¦ GPUã€Function Calling èƒ½åŠ›å¼± | ç§æœ‰åŒ–éƒ¨ç½²  |
  | æ··åˆæ–¹æ¡ˆ              | ç®€å•ä»»åŠ¡æœ¬åœ°ã€å¤æ‚ä»»åŠ¡äº‘ç«¯              | æ¶æ„å¤æ‚                        | ä¼ä¸šçº§åº”ç”¨  |

  ä¾èµ–åº“ï¼š

  # requirements-ai.txt
  openai >= 1.0.0          # OpenAI APIï¼ˆå¦‚æœä½¿ç”¨ GPTï¼‰
  anthropic >= 0.7.0       # Claude APIï¼ˆå¦‚æœä½¿ç”¨ Claudeï¼‰
  langchain >= 0.1.0       # å¯é€‰ï¼šå·¥å…·é“¾ç®¡ç†
  scipy >= 1.10.0          # FFT/ä¿¡å·å¤„ç†
  scikit-learn >= 1.2.0    # å¯é€‰ï¼šæœºå™¨å­¦ä¹ ç‰¹å¾
  pydantic >= 2.0.0        # æ•°æ®éªŒè¯

  ---
  ä¸ƒã€å®æ–½è·¯çº¿å›¾

  ç¬¬ä¸€é˜¶æ®µï¼ˆ2-3 å‘¨ï¼‰ï¼šåŸºç¡€å·¥å…·å±‚
  - åˆ›å»º waveform_viewer/ai/tools/ ç›®å½•
  - å®ç° 10-15 ä¸ªæ ¸å¿ƒå·¥å…·å‡½æ•°ï¼ˆæ•°æ®è®¿é—®ã€åŸºç¡€åˆ†æã€äº‹ä»¶åˆ†æï¼‰
  - ç¼–å†™å·¥å…·çš„å•å…ƒæµ‹è¯•
  - åˆ›å»º Function Schema å®šä¹‰

  ç¬¬äºŒé˜¶æ®µï¼ˆ1-2 å‘¨ï¼‰ï¼šæ³¨å†Œè¡¨å’Œä¸“å®¶ç³»ç»Ÿ
  - å®ç° ToolRegistry ç±»
  - å®ç° WaveformExpert ç±»
  - é›†æˆ LLM APIï¼ˆOpenAI/Claudeï¼‰
  - æµ‹è¯• Function Calling æµç¨‹

  ç¬¬ä¸‰é˜¶æ®µï¼ˆ1 å‘¨ï¼‰ï¼šUI é›†æˆ
  - åœ¨ main.py æ·»åŠ  --ai å‚æ•°
  - å®ç°äº¤äº’å¼ AI æŸ¥è¯¢ç•Œé¢
  - æ·»åŠ å¯¹è¯å†å²ç®¡ç†
  - é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–

  ç¬¬å››é˜¶æ®µï¼ˆæŒç»­ï¼‰ï¼šé«˜çº§åŠŸèƒ½
  - æ·»åŠ å¤šæ–‡ä»¶å¯¹æ¯”å·¥å…·
  - å®ç°æ•…éšœç±»å‹è‡ªåŠ¨åˆ†ç±»
  - æ·»åŠ æŠ¥å‘Šç”ŸæˆåŠŸèƒ½
  - é›†æˆå‘é‡æ•°æ®åº“ï¼ˆå†å²æ¡ˆä¾‹æ£€ç´¢ï¼‰
  - æ”¯æŒæµå¼è¾“å‡ºï¼ˆå¤§æ¨¡å‹ streamingï¼‰

  ---
  å…«ã€å…³é”®è®¾è®¡å»ºè®®

  âœ… ä¿æŒæ¶æ„æ•´æ´ï¼š

  - æ–°å¢çš„ AI æ¨¡å—åº”è¯¥å®Œå…¨ç‹¬ç«‹ï¼Œä¸ä¿®æ”¹ç°æœ‰æ ¸å¿ƒä»£ç 
  - é€šè¿‡ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰æ–¹å¼é›†æˆ
  - AI åŠŸèƒ½åº”è¯¥æ˜¯å¯é€‰çš„ï¼ˆé€šè¿‡ --ai å‚æ•°å¯ç”¨ï¼‰

  âœ… å·¥å…·å‡½æ•°è®¾è®¡åŸåˆ™ï¼š

  - åŸå­æ€§ï¼šæ¯ä¸ªå·¥å…·åªåšä¸€ä»¶äº‹
  - æ— çŠ¶æ€ï¼šå·¥å…·å‡½æ•°åº”è¯¥æ˜¯çº¯å‡½æ•°ï¼ˆè¾“å…¥ç›¸åŒåˆ™è¾“å‡ºç›¸åŒï¼‰
  - è¿”å›ç»“æ„åŒ–æ•°æ®ï¼šä½¿ç”¨ Dict/Listï¼Œä¾¿äº JSON åºåˆ—åŒ–
  - å¼‚å¸¸å¤„ç†ï¼šæ‰€æœ‰å·¥å…·éƒ½åº”è¯¥æ•è·å¼‚å¸¸å¹¶è¿”å›é”™è¯¯ä¿¡æ¯

  âœ… æ€§èƒ½ä¼˜åŒ–ï¼š

  - å¤§æ–‡ä»¶åˆ†æå‰å…ˆæ£€æŸ¥æ–‡ä»¶å¤§å°
  - FFT ç­‰è€—æ—¶æ“ä½œåº”è¯¥æœ‰ç¼“å­˜æœºåˆ¶
  - å¯¹äºå¤§é‡é€šé“ï¼Œæ”¯æŒæ‰¹é‡åˆ†æå’Œå¹¶è¡Œå¤„ç†

  âœ… å®‰å…¨æ€§ï¼š

  - æ–‡ä»¶è·¯å¾„éªŒè¯ï¼ˆé˜²æ­¢è·¯å¾„éå†æ”»å‡»ï¼‰
  - LLM è¾“å‡ºè¿‡æ»¤ï¼ˆé˜²æ­¢ Prompt Injectionï¼‰
  - API Key ç®¡ç†ï¼ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œä¸ç¡¬ç¼–ç ï¼‰

  ---
  ä¹ã€ç¤ºä¾‹ä»£ç ç‰‡æ®µï¼ˆå¿«é€Ÿå¯åŠ¨ï¼‰

  å¦‚æœä½ æƒ³ç«‹å³å¼€å§‹ï¼Œå¯ä»¥å…ˆåˆ›å»ºä¸€ä¸ªæœ€å°å¯è¡Œç‰ˆæœ¬ï¼š

  # waveform_viewer/ai/simple_expert.pyï¼ˆæœ€ç®€å®ç°ï¼‰

  from waveform_viewer.core.reader import ComtradeReader
  import numpy as np

  class SimpleExpert:
      """ç®€å•ä¸“å®¶ç³»ç»Ÿï¼ˆåŸºäºè§„åˆ™ï¼Œä¸ä¾èµ– LLMï¼‰"""

      def analyze_voltage_sag(self, cfg_path: str) -> str:
          """åˆ†æç”µå‹è·Œè½"""
          reader = ComtradeReader(cfg_path)

          results = []
          for ch in reader.analog_channels:
              if 'ç”µå‹' in ch.name:
                  data = np.array(reader.get_analog_data(ch.index))
                  min_val = np.min(data)

                  if min_val < 80:  # ç”µå‹è·Œè½é˜ˆå€¼
                      results.append(
                          f"{ch.name} å‘ç”Ÿç”µå‹è·Œè½ï¼Œæœ€ä½å€¼ {min_val:.2f}{ch.unit}"
                      )

          return "\n".join(results) if results else "æœªæ£€æµ‹åˆ°ç”µå‹è·Œè½"

      def analyze_fault_type(self, cfg_path: str) -> str:
          """æ•…éšœç±»å‹åˆ¤æ–­ï¼ˆç®€å•è§„åˆ™ï¼‰"""
          reader = ComtradeReader(cfg_path)

          # è·å–ä¸‰ç›¸ç”µå‹
          voltages = {}
          for phase in ['A', 'B', 'C']:
              ch = reader.get_channel_by_name(f'{phase}ç›¸.*ç”µå‹')
              if ch:
                  voltages[phase] = np.min(reader.get_analog_data(ch.index))

          # ç®€å•åˆ¤æ–­é€»è¾‘
          low_voltage_phases = [p for p, v in voltages.items() if v < 80]

          if len(low_voltage_phases) == 1:
              return f"å•ç›¸æ¥åœ°æ•…éšœï¼ˆ{low_voltage_phases[0]}ç›¸ï¼‰"
          elif len(low_voltage_phases) == 2:
              return f"ä¸¤ç›¸çŸ­è·¯æ•…éšœï¼ˆ{','.join(low_voltage_phases)}ï¼‰"
          elif len(low_voltage_phases) == 3:
              return "ä¸‰ç›¸çŸ­è·¯æ•…éšœ"
          else:
              return "æœªæ£€æµ‹åˆ°æ˜æ˜¾æ•…éšœ"

  # ä½¿ç”¨ç¤ºä¾‹
  expert = SimpleExpert()
  print(expert.analyze_voltage_sag("waves/20241030_115240/20241030_115240.cfg"))
  print(expert.analyze_fault_type("waves/20241030_115240/20241030_115240.cfg"))

  è¿™ä¸ªç®€å•ç‰ˆæœ¬å¯ä»¥å…ˆéªŒè¯æ¶æ„å¯è¡Œæ€§ï¼Œä¹‹åå†é€æ­¥æ›¿æ¢ä¸º LLM é©±åŠ¨çš„æ™ºèƒ½åˆ†æã€‚

  ---
  åã€æ€»ç»“

  ä½ çš„é¡¹ç›®éå¸¸é€‚åˆé›†æˆ AI ä¸“å®¶ç³»ç»Ÿï¼Œå› ä¸ºï¼š

  1. âœ… å·²æœ‰æ’ä»¶æ¶æ„ï¼šæ‰©å±•ç‚¹æ¸…æ™°
  2. âœ… æ•°æ®æ¨¡å‹å®Œå–„ï¼šComtradeReader æä¾›äº†è‰¯å¥½çš„æ•°æ®è®¿é—®æ¥å£
  3. âœ… å·¥å…·åŸºç¡€è‰¯å¥½ï¼šå·²æœ‰ç»Ÿè®¡ã€å¯¼å‡ºç­‰å·¥å…·å¯ä»¥ç›´æ¥å¤ç”¨
  4. âœ… æ–‡æ¡£å®Œå–„ï¼šæœ‰è¯¦ç»†çš„å¼€å‘è€…æŒ‡å—

  æ¨èçš„å®æ–½è·¯å¾„ï¼š
  1. å…ˆå®ç°å·¥å…·å‡½æ•°å±‚ï¼ˆç‹¬ç«‹äº LLMï¼‰
  2. é›†æˆç®€å•çš„è§„åˆ™ä¸“å®¶ç³»ç»ŸéªŒè¯æ¶æ„
  3. æ¥å…¥ LLM Function Calling å®ç°æ™ºèƒ½åˆ†æ
  4. é€æ­¥æ·»åŠ é«˜çº§åˆ†æèƒ½åŠ›ï¼ˆFFTã€æ•…éšœåˆ†ç±»ã€æŠ¥å‘Šç”Ÿæˆï¼‰

  é¢„è®¡å·¥ä½œé‡ï¼š
  - åŸºç¡€ç‰ˆæœ¬ï¼ˆ10-15 ä¸ªå·¥å…· + LLM é›†æˆï¼‰ï¼š3-4 å‘¨
  - å®Œæ•´ç‰ˆæœ¬ï¼ˆ30+ å·¥å…· + é«˜çº§åŠŸèƒ½ï¼‰ï¼š2-3 ä¸ªæœˆ