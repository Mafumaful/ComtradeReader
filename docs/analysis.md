# COMTRADE文件格式详细分析

## 概述

COMTRADE（**COM**mon format for **T**ransient **DA**ta **E**xchange for power systems）是电力系统暂态数据交换的标准格式，由IEEE和IEC联合制定（IEEE C37.111 / IEC 60255-24）。

一个完整的COMTRADE记录通常包含4个文件：
- `.cfg` - 配置文件（Configuration）
- `.dat` - 数据文件（Data）
- `.hdr` - 头文件（Header）
- `.rpt` - 报告文件（Report）

---

## 1. CFG文件 - 配置文件

### 文件特性
- **格式**: ASCII文本文件
- **编码**: GBK/GB2312（中国电力系统）或ASCII（国际标准）
- **大小**: 通常5-10 KB
- **换行符**: CRLF（Windows风格）
- **作用**: 定义数据文件的结构和通道信息

### 文件结构

#### 第1行：站点信息
```
西柏坡电厂,电压闭环,1999
```
格式：`站点名,设备名,COMTRADE版本年份`

#### 第2行：通道总数
```
209,47A,162D
```
格式：`总通道数,模拟通道数A,数字通道数D`
- 总通道数 = 模拟通道数 + 数字通道数
- 本例：47个模拟量 + 162个数字量 = 209个通道

#### 第3行起：模拟通道定义
```
1,机端电压百分值,A,,%,0.00304266,0.00000000,0,32631,32766,1.000000,1.000000,S
```

字段说明：
| 位置 | 字段 | 示例值 | 说明 |
|------|------|--------|------|
| 1 | 通道序号 | 1 | 唯一标识符 |
| 2 | 通道名称 | 机端电压百分值 | 中文或英文描述 |
| 3 | 相位 | A | A/B/C或空 |
| 4 | 电路元件 | (空) | 可选 |
| 5 | 单位 | % | 物理单位 |
| 6 | 乘数a | 0.00304266 | 转换系数 |
| 7 | 偏移量b | 0.00000000 | 转换偏移 |
| 8 | 偏移 | 0 | 时间偏移 |
| 9 | 最小值 | 32631 | 原始数据范围 |
| 10 | 最大值 | 32766 | 原始数据范围 |
| 11 | 主系数 | 1.000000 | 额定值 |
| 12 | 次系数 | 1.000000 | 额定值 |
| 13 | 类型 | S | P=主要/S=次要 |

**数据转换公式**：
```
实际值 = a × 原始值 + b
```
例如：原始值32700 → 实际值 = 0.00304266 × 32700 + 0 = 99.495%

#### 数字通道定义
```
1,手动录波,,,0
```
格式：`序号,通道名,相位,电路元件,正常状态值`

#### 采样率信息
```
50.000          # 系统频率（Hz）
1               # 采样率组数
300,6000        # 采样率(Hz),样本数
```

#### 时间信息
```
13/10/2025,05:18:16.923542    # 开始时间
13/10/2025,05:18:26.919686    # 结束时间
```

#### 数据格式
```
BINARY          # 或ASCII
1.000000        # 时间倍数
```

### CFG文件作用
1. **定义数据结构** - 告诉读取程序如何解析.dat文件
2. **通道映射** - 将原始数据映射到物理量
3. **单位转换** - 提供转换公式将整数转为实际值
4. **元数据** - 记录站点、时间、采样率等信息

---

## 2. DAT文件 - 数据文件

### 文件特性
- **格式**: 二进制数据（BINARY）或ASCII文本
- **大小**: 通常几百KB到几MB
- **本例大小**: 744000字节（727 KB）
- **作用**: 存储实际的波形采样数据

### 二进制格式结构

#### 每个样本的数据结构（124字节）

```
┌─────────────────────────────────────────────────────┐
│ 样本号（4字节）           │ 时间戳（4字节）          │
│ Unsigned Int (Little)    │ Unsigned Int (Little)   │
│                          │ 单位：微秒               │
├─────────────────────────────────────────────────────┤
│ 模拟通道数据（94字节）                               │
│ 47个通道 × 2字节/通道                               │
│ Signed Short (Little Endian)                       │
├─────────────────────────────────────────────────────┤
│ 数字通道数据（21字节）                               │
│ 162位 → 21字节（向上取整）                          │
│ 按位存储：bit 0 = 通道1, bit 1 = 通道2...          │
├─────────────────────────────────────────────────────┤
│ 填充字节（5字节）                                    │
│ 用于字节对齐                                        │
└─────────────────────────────────────────────────────┘
总计：124字节/样本
```

#### 计算公式
```python
# 模拟通道字节数
analog_bytes = 模拟通道数 × 2

# 数字通道字节数（向上取整到字节边界）
digital_bytes = (数字通道数 + 7) // 8

# 每样本总字节数
bytes_per_sample = 8 + analog_bytes + digital_bytes + padding

# 本例
bytes_per_sample = 8 + 94 + 21 + 1 = 124字节
```

#### 样本数据示例

**样本1（前124字节）：**
```
偏移量   内容              说明
0-3     01 00 00 00      样本号 = 1
4-7     C0 0B 00 00      时间戳 = 2912微秒 = 0.002912秒
8-9     F5 7F            通道1原始值 = 32757
10-11   F1 7F            通道2原始值 = 32753
...
102-123                  数字通道和填充
```

### 数据读取步骤
1. 根据CFG文件确定每样本字节数
2. 按顺序读取每个样本
3. 提取样本号和时间戳
4. 提取模拟量原始值（16位有符号整数）
5. 应用CFG中的转换公式得到实际值
6. 解析数字量位

### 本例数据统计
- **样本数**: 6000个
- **采样率**: 300 Hz（每3.33ms一个样本）
- **时间跨度**: 约20秒（0.003s ~ 19.968s）
- **文件大小**: 6000 × 124 = 744000字节

---

## 3. HDR文件 - 头文件

### 文件特性
- **格式**: XML 1.1文档
- **编码**: UTF-8（带BOM）
- **大小**: 通常50-100 KB
- **换行符**: CRLF
- **作用**: 记录故障事件、数字量变化和系统状态

### XML结构

```xml
<?xml version="1.1" encoding="UTF-8"?>
<FaultReport>
    <!-- 故障开始时间 -->
    <FaultStartTime>2025-10-13 05:18:26:919</FaultStartTime>

    <!-- 跳闸信息（数字量变化记录） -->
    <TripInfo>
        <time> 0ms </time>              <!-- 相对时间 -->
        <name> sigb_out001 </name>      <!-- 信号名称 -->
        <phase>     </phase>            <!-- 相位 -->
        <value> 1 </value>              <!-- 状态值（0/1） -->
    </TripInfo>

    <TripInfo>
        <time> 1000ms </time>
        <name> sigb_out001 </name>
        <phase>     </phase>
        <value> 0 </value>
    </TripInfo>

    <!-- 更多TripInfo记录... -->

    <!-- 数据文件大小 -->
    <DataFileSize>744000</DataFileSize>

    <!-- 故障保持时间 -->
    <FaultKeepingTime>0ms</FaultKeepingTime>

    <!-- 数字量状态 -->
    <DigitalStatus>
        <name> 就地增磁 </name>
        <value> 0 </value>
    </DigitalStatus>

    <DigitalStatus>
        <name> 就地减磁 </name>
        <value> 0 </value>
    </DigitalStatus>

    <!-- 更多数字量状态... -->
</FaultReport>
```

### 主要内容

#### 1. 故障时间信息
- **FaultStartTime**: 故障/录波开始的绝对时间
- **FaultKeepingTime**: 故障保持时间

#### 2. TripInfo记录
记录每个数字量的状态变化：
- **time**: 相对于开始时间的毫秒数
- **name**: 数字信号名称
- **value**: 状态值（0=关闭/正常，1=开启/故障）

本例中`sigb_out001`信号有多次状态变化：
```
0ms: 1 → 信号激活
1000ms: 0 → 信号恢复
2464ms: 1 → 再次激活
...
```

#### 3. DigitalStatus
记录所有数字量在录波结束时的最终状态

#### 4. DataFileSize
确认.dat文件的字节数，用于验证文件完整性

### HDR文件作用
1. **事件记录** - 记录故障和保护动作
2. **时序分析** - 提供数字量变化的精确时间
3. **故障诊断** - 帮助分析故障原因和保护动作顺序
4. **数据验证** - 通过文件大小校验数据完整性

---

## 4. RPT文件 - 报告文件

### 文件特性
- **格式**: 专有二进制格式（混合文本和二进制）
- **大小**: 通常20-50 KB
- **本例大小**: 28-29 KB
- **作用**: 设备专有的详细报告和统计信息

### 内容推测

RPT文件通常包含：

#### 1. 二进制数据块
- 设备配置参数
- 内部状态信息
- 计算中间结果
- 统计数据

#### 2. 可能的文本信息
从部分可读内容推测：
- 浮点数数据（IEEE 754格式）
- 设备型号和版本信息
- 参数设置值
- 计算结果

#### 3. 专有格式
- **厂商特定**: 不同设备制造商的RPT格式各不相同
- **非标准化**: COMTRADE标准未严格定义RPT格式
- **可选文件**: 有些系统不生成RPT文件

### RPT文件的局限性
1. **不可移植** - 通常只能用厂商专用软件打开
2. **格式未公开** - 需要厂商文档才能解析
3. **非必需** - 对于基本波形分析不需要RPT文件

### 本例RPT分析
从文件内容观察到：
- 包含大量浮点数（如`@I`, `@�<`, `?�`等IEEE 754编码）
- 可能包含参数快照和设定值
- 包含一些时间戳数据
- 文件末尾有设备标识信息

---

## 文件关系与使用流程

```
┌─────────────────────────────────────────────────────┐
│                  COMTRADE记录                        │
├─────────────────────────────────────────────────────┤
│                                                      │
│  ┌──────────┐     ┌──────────┐                     │
│  │   CFG    │────>│   DAT    │                     │
│  │ 配置文件  │     │ 数据文件  │                     │
│  │ (必需)    │     │ (必需)    │                     │
│  └──────────┘     └──────────┘                     │
│       │                  │                          │
│       │                  │                          │
│       v                  v                          │
│  【定义结构】        【存储波形】                      │
│       │                  │                          │
│       └────────┬─────────┘                          │
│                v                                    │
│         ┌─────────────┐                            │
│         │  读取和解析  │                            │
│         └─────────────┘                            │
│                │                                    │
│       ┌────────┴────────┐                          │
│       v                 v                          │
│  ┌──────────┐     ┌──────────┐                    │
│  │   HDR    │     │   RPT    │                    │
│  │ 头文件    │     │ 报告文件  │                    │
│  │ (可选)    │     │ (可选)    │                    │
│  └──────────┘     └──────────┘                    │
│       │                  │                          │
│       v                  v                          │
│  【事件信息】       【设备报告】                      │
│                                                      │
└─────────────────────────────────────────────────────┘
```

### 标准使用流程

1. **读取CFG文件**
   - 获取通道定义
   - 确定数据格式
   - 获取采样参数

2. **读取DAT文件**
   - 根据CFG结构解析二进制数据
   - 应用转换公式得到物理量
   - 构建时间序列

3. **读取HDR文件（可选）**
   - 获取事件时间线
   - 分析数字量变化
   - 辅助故障诊断

4. **读取RPT文件（可选）**
   - 使用厂商专用工具
   - 获取设备详细信息

---

## 文件命名规范

本例文件命名：
```
01738_20251013_051826_919_B套_ sigb_out001
│││││ │││││││││ │││││││ │││ │││   ││││││││││
││││└─────────────────────────── 序列号
│││└──────────────────────────── 日期(YYYYMMDD)
││└───────────────────────────── 时间(HHMMSS)
│└────────────────────────────── 毫秒
└─────────────────────────────── 其他标识(B套/设备编号等)
```

---

## 技术规范参考

### 国际标准
- **IEEE C37.111-2013**: IEEE Standard for Electrical Power System Device Data Format (COMTRADE)
- **IEC 60255-24**: Measuring relays and protection equipment

### COMTRADE版本历史
- **1991**: 初版
- **1999**: 增加扩展格式支持（本例使用）
- **2013**: 最新版本，支持更多数据类型

### 支持的数据格式
1. **BINARY** - 二进制格式（更紧凑，本例使用）
2. **ASCII** - 文本格式（更易读，文件更大）
3. **BINARY32** - 32位浮点数格式（2013版）
4. **FLOAT32** - IEEE浮点格式（2013版）

---

## 实际应用场景

### 1. 电力系统故障分析
- 短路故障录波
- 保护动作分析
- 继电保护测试验证

### 2. 发电机励磁系统（本例）
- AVR（自动电压调节器）性能测试
- PSS（电力系统稳定器）响应分析
- 励磁系统参数整定

### 3. 设备测试与调试
- 新设备投运测试
- 参数优化调整
- 性能评估

### 4. 科研与教学
- 算法验证
- 仿真对比
- 教学演示

---

## 数据质量验证

### 完整性检查
```python
# 验证文件大小
expected_size = num_samples × bytes_per_sample
actual_size = file_size_in_bytes
assert actual_size == expected_size

# 验证时间连续性
time_intervals = diff(time_values)
expected_interval = 1 / sample_rate
assert all(abs(intervals - expected_interval) < tolerance)
```

### 有效性检查
```python
# 检查数据范围
for channel in analog_channels:
    assert min_value <= data <= max_value

# 检查异常值
assert not has_nan(data)
assert not has_inf(data)
```

---

## 常见问题与解决方案

### 问题1: 中文乱码
**原因**: CFG文件使用GBK编码
**解决**: 优先尝试GBK/GB2312编码读取

### 问题2: 时间戳不正确
**原因**: 时间戳单位误判（微秒vs毫秒）
**解决**: 根据采样率验证时间间隔

### 问题3: 数据范围异常
**原因**: 转换系数a、b使用错误
**解决**: 仔细核对CFG文件中的转换公式

### 问题4: 字节对齐问题
**原因**: 不同设备可能添加填充字节
**解决**: 根据实际文件大小计算每样本字节数

---

## 总结

| 文件 | 必需性 | 格式 | 编码 | 大小 | 主要作用 |
|------|--------|------|------|------|----------|
| CFG | ✅必需 | 文本 | GBK/ASCII | 5-10KB | 定义数据结构 |
| DAT | ✅必需 | 二进制 | N/A | 数百KB-MB | 存储波形数据 |
| HDR | ⭕可选 | XML | UTF-8 | 50-100KB | 记录事件信息 |
| RPT | ⭕可选 | 专有 | 混合 | 20-50KB | 设备详细报告 |

**核心文件**: CFG + DAT 足以进行基本波形分析
**完整记录**: CFG + DAT + HDR + RPT 提供完整的故障记录

---

## 相关工具

### 本项目工具
- `waveform_viewer.py` - 读取CFG+DAT并可视化
- `verify_data.py` - 数据质量验证

### 其他常用工具
- **COMTRADE Viewer** - 通用查看器
- **厂商专用软件** - 完整功能（包括RPT解析）
- **Python库**: `comtrade` - 第三方COMTRADE解析库
- **MATLAB** - 电力系统工具箱

---

*文档版本: 1.0*
*更新日期: 2025-10-27*
*基于文件: 西柏坡电厂励磁系统COMTRADE记录*
